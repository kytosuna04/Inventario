#include <iostream>
#include <string>
#include <iomanip>
#include <stdexcept>
#include <ctime>
using namespace std;

// Estructura principal del producto
struct Producto {
    int id;
    string nombre;
    double precio;
    int cantidad;
    string proveedor;
    int stockMinimo;  // Característica adicional
    
    // Método para calcular valor total (uso de estructura con función)
    double calcularValorTotal() const {
        return precio * cantidad;
    }
    
    // Método para verificar si necesita reabastecimiento
    bool requiereReabastecimiento() const {
        return cantidad <= stockMinimo;
    }
};

// Excepción personalizada para productos no encontrados
class ExcepcionProductoNoEncontrado : public exception {
private:
    string mensaje;
public:
    ExcepcionProductoNoEncontrado(const string& msg) : mensaje(msg) {}
    const char* what() const noexcept override {
        return mensaje.c_str();
    }
};

// Excepción para stock insuficiente
class ExcepcionStockInsuficiente : public exception {
private:
    string mensaje;
public:
    ExcepcionStockInsuficiente(const string& msg) : mensaje(msg) {}
    const char* what() const noexcept override {
        return mensaje.c_str();
    }
};

const int CAPACIDAD_MAXIMA = 50;
const int PRODUCTOS_INICIALES = 12;

// === PROTOTIPOS DE FUNCIONES ===
void cargarInventarioInicial(Producto arr[], int& total);
void mostrarEncabezado(const string& titulo);
void presentarMenu();
void listarInventarioCompleto(Producto arr[], int total);
void registrarNuevoProducto(Producto arr[], int& total);
void buscarProductoPorNombre(Producto arr[], int total);
void buscarProductoPorCodigo(Producto arr[], int total);
void aplicarOrdenamientoBurbuja(Producto arr[], int total, bool porPrecio);
void aplicarOrdenamientoSeleccion(Producto arr[], int total);
void gestionarStockConPunteros(Producto* ptr);
void mostrarAlertasStock(Producto arr[], int total);
void generarReporteSencillo(Producto arr[], int total);
Producto* localizarProducto(Producto arr[], int total, int codigo);
void intercambiar(Producto* a, Producto* b);
void esperarUsuario();

// === FUNCIÓN PRINCIPAL ===
int main() {
    Producto inventario[CAPACIDAD_MAXIMA];
    int totalProductos = 0;
    int eleccion;
    
    cargarInventarioInicial(inventario, totalProductos);
    
    cout << "\n";
    mostrarEncabezado("SISTEMA DE CONTROL DE INVENTARIO");


 do {
        presentarMenu();
        cout << "\nIngrese su opcion: ";
        cin >> eleccion;
        cin.ignore();
        
        try {
            switch(eleccion) {
                case 1:
                    mostrarEncabezado("INVENTARIO GENERAL");
                    listarInventarioCompleto(inventario, totalProductos);
                    break;
                    
                case 2:
                    mostrarEncabezado("REGISTRO DE PRODUCTO");
                    registrarNuevoProducto(inventario, totalProductos);
                    break;
                    
                case 3:
                    mostrarEncabezado("BUSQUEDA POR NOMBRE");
                    buscarProductoPorNombre(inventario, totalProductos);
                    break;
                    
                case 4:
                    mostrarEncabezado("BUSQUEDA POR CODIGO");
                    buscarProductoPorCodigo(inventario, totalProductos);
                    break;
                    
                case 5: {
                    int subOpcion;
                    mostrarEncabezado("ORDENAMIENTO DE INVENTARIO");
                    cout << "1. Ordenar por PRECIO (Metodo Burbuja)" << endl;
                    cout << "2. Ordenar por CANTIDAD (Metodo Seleccion)" << endl;
                    cout << "Elija metodo: ";
                    cin >> subOpcion;
                    
                    if(subOpcion == 1) {
                        aplicarOrdenamientoBurbuja(inventario, totalProductos, true);
                        cout << "\n[OK] Inventario ordenado por PRECIO (menor a mayor)" << endl;
                    } else if(subOpcion == 2) {
                        aplicarOrdenamientoSeleccion(inventario, totalProductos);
                        cout << "\n[OK] Inventario ordenado por CANTIDAD (menor a mayor)" << endl;
                    }
                    break;
                }
                    
                case 6: {
                    mostrarEncabezado("GESTION DE STOCK (PUNTEROS)");
                    int codigo;
                    cout << "Ingrese codigo del producto: ";
                    cin >> codigo;
                    Producto* ptrProducto = localizarProducto(inventario, totalProductos, codigo);
                    gestionarStockConPunteros(ptrProducto);
                    break;
                }
                    
                case 7:
                    mostrarEncabezado("ALERTAS DE INVENTARIO");
                    mostrarAlertasStock(inventario, totalProductos);
                    break;
                    
                case 8:
                    mostrarEncabezado("REPORTE DE INVENTARIO");
                    generarReporteSencillo(inventario, totalProductos);
                    break;
                    
                case 0:
                    mostrarEncabezado("CERRANDO SISTEMA");
                    cout << "Gracias por utilizar el sistema. Hasta pronto!" << endl;
                    break;
                    
                default:
                    cout << "\n[ERROR] Opcion no valida. Intente nuevamente." << endl;
            }
            
        } catch (const ExcepcionProductoNoEncontrado& e) {
            cout << "\n[EXCEPCION] " << e.what() << endl;
        } catch (const ExcepcionStockInsuficiente& e) {
            cout << "\n[EXCEPCION] " << e.what() << endl;
        } catch (const exception& e) {
            cout << "\n[ERROR CRITICO] " << e.what() << endl;
        }
        
        if(eleccion != 0) esperarUsuario();
        
    } while(eleccion != 0);
    
    return 0;
}

// === IMPLEMENTACIÓN DE FUNCIONES ===

void cargarInventarioInicial(Producto arr[], int& total) {
    arr[0] = {1001, "Laptop HP Pavilion 15", 18999.00, 8, "HP Mexico", 3};
    arr[1] = {1002, "Mouse Inalambrico Logitech", 450.00, 22, "Logitech", 10};
    arr[2] = {1003, "Teclado Mecanico Redragon", 1100.00, 15, "Redragon", 5};
    arr[3] = {1004, "Monitor Samsung 24 pulgadas", 3200.00, 6, "Samsung", 2};
    arr[4] = {1005, "Camara Web Full HD", 850.00, 12, "Genius", 5};
    arr[5] = {1006, "Audifonos Sony Bluetooth", 2100.00, 18, "Sony Corp", 8};
    arr[6] = {1007, "Disco SSD 500GB Kingston", 1350.00, 25, "Kingston Tech", 12};
    arr[7] = {1008, "Memoria USB 64GB SanDisk", 280.00, 40, "SanDisk", 15};
    arr[8] = {1009, "Impresora Multifuncional Epson", 3800.00, 5, "Epson", 2};
    arr[9] = {1010, "Router WiFi TP-Link Dual Band", 1250.00, 10, "TP-Link", 4};
    arr[10] = {1011, "Hub USB 4 Puertos", 320.00, 28, "Belkin", 10};
    arr[11] = {1012, "Cable HDMI 2 metros", 180.00, 35, "Cables Inc", 20};
    
    total = PRODUCTOS_INICIALES;
}

void mostrarEncabezado(const string& titulo) {
    cout << "\n" << string(70, '=') << endl;
    cout << "  " << titulo << endl;
    cout << string(70, '=') << endl;
}

void presentarMenu() {
    cout << "\n--- MENU PRINCIPAL ---" << endl;
    cout << "[1] Listar todos los productos" << endl;
    cout << "[2] Agregar nuevo producto" << endl;
    cout << "[3] Buscar por nombre" << endl;
    cout << "[4] Buscar por codigo ID" << endl;
    cout << "[5] Ordenar inventario" << endl;
    cout << "[6] Modificar stock " << endl;
    cout << "[7] Ver alertas de stock bajo" << endl;
    cout << "[8] Generar reporte de inventario" << endl;
    cout << "[9] Salir del sistema" << endl;
}

void listarInventarioCompleto(Producto arr[], int total) {
    
    cout << "\n" << left << setw(10) << "CODIGO" 
         << setw(32) << "NOMBRE PRODUCTO"
         << right << setw(12) << "PRECIO"
         << setw(10) << "STOCK"
         << setw(14) << "VALOR TOTAL" << endl;
    cout << string(78, '-') << endl;
    
    for(int i = 0; i < total; i++) {
        cout << left << setw(10) << arr[i].id
             << setw(32) << arr[i].nombre.substr(0, 30)
             << right << setw(12) << fixed << setprecision(2) << arr[i].precio
             << setw(10) << arr[i].cantidad
             << setw(14) << arr[i].calcularValorTotal() << endl;
    }
    
    cout << string(78, '-') << endl;
    cout << "TOTAL DE PRODUCTOS REGISTRADOS: " << total << endl;
}

void registrarNuevoProducto(Producto arr[], int& total) {
    if(total >= CAPACIDAD_MAXIMA) {
        throw runtime_error("Capacidad maxima alcanzada. No se pueden agregar mas productos.");
    }
    
    Producto nuevo;
    
    cout << "\nCodigo del producto: ";
    cin >> nuevo.id;
    cin.ignore();
    
    // Verificar duplicados
    for(int i = 0; i < total; i++) {
        if(arr[i].id == nuevo.id) {
            throw runtime_error("Ya existe un producto con ese codigo.");
        }
    }
    
    cout << "Nombre del producto: ";
    getline(cin, nuevo.nombre);
    
    cout << "Precio unitario: $";
    cin >> nuevo.precio;
    
    cout << "Cantidad en stock: ";
    cin >> nuevo.cantidad;
    
    cout << "Stock minimo requerido: ";
    cin >> nuevo.stockMinimo;
    
    cin.ignore();
    cout << "Proveedor: ";
    getline(cin, nuevo.proveedor);
    
    arr[total] = nuevo;
    total++;
    
    cout << "\n[OK] Producto registrado exitosamente!" << endl;
    cout << "Codigo asignado: " << nuevo.id << endl;
}

void buscarProductoPorNombre(Producto arr[], int total) {
    string termino;
    cout << "\nIngrese nombre a buscar: ";
    getline(cin, termino);
    
    bool encontrado = false;
    
    for(int i = 0; i < total; i++) {
        if(arr[i].nombre.find(termino) != string::npos) {
            if(!encontrado) {
                cout << "\n--- RESULTADOS ENCONTRADOS ---" << endl;
                encontrado = true;
            }
            
            cout << "\nCodigo: " << arr[i].id << endl;
            cout << "Nombre: " << arr[i].nombre << endl;
            cout << "Proveedor: " << arr[i].proveedor << endl;
            cout << "Precio: $" << fixed << setprecision(2) << arr[i].precio << endl;
            cout << "Stock: " << arr[i].cantidad << " unidades" << endl;
            cout << "Valor inventario: $" << arr[i].calcularValorTotal() << endl;
            
            if(arr[i].requiereReabastecimiento()) {
                cout << "[ALERTA] Stock bajo! Minimo: " << arr[i].stockMinimo << endl;
            }
            cout << string(50, '-') << endl;
        }
    }
    
    if(!encontrado) {
        throw ExcepcionProductoNoEncontrado("No se encontraron productos con ese nombre.");
    }
}

void buscarProductoPorCodigo(Producto arr[], int total) {
    int codigo;
    cout << "\nIngrese codigo del producto: ";
    cin >> codigo;
    
    Producto* resultado = localizarProducto(arr, total, codigo);
    
    cout << "\n--- INFORMACION DEL PRODUCTO ---" << endl;
    cout << "Codigo: " << resultado->id << endl;
    cout << "Nombre: " << resultado->nombre << endl;
    cout << "Proveedor: " << resultado->proveedor << endl;
    cout << "Precio unitario: $" << fixed << setprecision(2) << resultado->precio << endl;
    cout << "Stock actual: " << resultado->cantidad << " unidades" << endl;
    cout << "Stock minimo: " << resultado->stockMinimo << " unidades" << endl;
    cout << "Valor total en inventario: $" << resultado->calcularValorTotal() << endl;
    
    if(resultado->requiereReabastecimiento()) {
        cout << "\n[ALERTA] Este producto requiere reabastecimiento urgente!" << endl;
    }
}

// Ordenamiento por burbuja (para precio)
void aplicarOrdenamientoBurbuja(Producto arr[], int total, bool porPrecio) {
    for(int i = 0; i < total - 1; i++) {
        for(int j = 0; j < total - i - 1; j++) {
            bool condicion = porPrecio ? 
                (arr[j].precio > arr[j+1].precio) : 
                (arr[j].nombre > arr[j+1].nombre);
            
            if(condicion) {
                intercambiar(&arr[j], &arr[j+1]);
            }
        }
    }
}

// Ordenamiento por selección (para cantidad)
void aplicarOrdenamientoSeleccion(Producto arr[], int total) {
    for(int i = 0; i < total - 1; i++) {
        int indiceMinimo = i;
        
        for(int j = i + 1; j < total; j++) {
            if(arr[j].cantidad < arr[indiceMinimo].cantidad) {
                indiceMinimo = j;
            }
        }
        
        if(indiceMinimo != i) {
            intercambiar(&arr[i], &arr[indiceMinimo]);
        }
    }
}

// Gestión de stock usando punteros (característica importante)
void gestionarStockConPunteros(Producto* ptr) {
    cout << "\n--- PRODUCTO SELECCIONADO ---" << endl;
    cout << "Nombre: " << ptr->nombre << endl;
    cout << "Stock actual: " << ptr->cantidad << " unidades" << endl;
    cout << "Stock minimo: " << ptr->stockMinimo << " unidades" << endl;
    
    int opcion;
    cout << "\n1. Aumentar stock (entrada)" << endl;
    cout << "2. Disminuir stock (salida)" << endl;
    cout << "3. Actualizar precio" << endl;
    cout << "Seleccione operacion: ";
    cin >> opcion;
    
    switch(opcion) {
        case 1: {
            int cantidad;
            cout << "Unidades a agregar: ";
            cin >> cantidad;
            ptr->cantidad += cantidad;
            cout << "\n[OK] Stock actualizado: " << ptr->cantidad << " unidades" << endl;
            break;
        }
        case 2: {
            int cantidad;
            cout << "Unidades a retirar: ";
            cin >> cantidad;
            
            if(ptr->cantidad < cantidad) {
                throw ExcepcionStockInsuficiente("No hay suficiente stock para realizar esta operacion.");
            }
            
            ptr->cantidad -= cantidad;
            cout << "\n[OK] Stock actualizado: " << ptr->cantidad << " unidades" << endl;
            
            if(ptr->requiereReabastecimiento()) {
                cout << "[ADVERTENCIA] Stock por debajo del minimo permitido!" << endl;
            }
            break;
        }
        case 3: {
            double nuevoPrecio;
            cout << "Precio actual: $" << fixed << setprecision(2) << ptr->precio << endl;
            cout << "Nuevo precio: $";
            cin >> nuevoPrecio;
            
            double diferencia = nuevoPrecio - ptr->precio;
            double porcentaje = (diferencia / ptr->precio) * 100;
            
            ptr->precio = nuevoPrecio;
            
            cout << "\n[OK] Precio actualizado!" << endl;
            cout << "Variacion: " << (porcentaje > 0 ? "+" : "") 
                 << fixed << setprecision(2) << porcentaje << "%" << endl;
            break;
        }
        default:
            cout << "\n[ERROR] Operacion no valida." << endl;
    }
}

void mostrarAlertasStock(Producto arr[], int total) {
    bool hayAlertas = false;
    
    cout << "\nRevisando inventario en busca de productos con stock bajo..." << endl;
    cout << string(70, '-') << endl;
    
    for(int i = 0; i < total; i++) {
        if(arr[i].requiereReabastecimiento()) {
            if(!hayAlertas) {
                cout << "\n[!] PRODUCTOS QUE REQUIEREN REABASTECIMIENTO:" << endl;
                hayAlertas = true;
            }
            
            cout << "\nCodigo: " << arr[i].id << endl;
            cout << "Producto: " << arr[i].nombre << endl;
            cout << "Stock actual: " << arr[i].cantidad << " unidades" << endl;
            cout << "Stock minimo: " << arr[i].stockMinimo << " unidades" << endl;
            cout << "Proveedor: " << arr[i].proveedor << endl;
            cout << "Sugerencia: Ordenar al menos " 
                 << (arr[i].stockMinimo - arr[i].cantidad + 5) << " unidades" << endl;
            cout << string(50, '.');
        }
    }
    
    if(!hayAlertas) {
        cout << "\n[OK] Todos los productos tienen stock adecuado." << endl;
    }
}

void generarReporteSencillo(Producto arr[], int total) {
    double valorTotalInventario = 0;
    int totalUnidades = 0;
    double precioPromedio = 0;
    
    cout << "\nGenerando reporte..." << endl;
    
    cout << string(70, '=') << endl;
    
    for(int i = 0; i < total; i++) {
        valorTotalInventario += arr[i].calcularValorTotal();
        totalUnidades += arr[i].cantidad;
        precioPromedio += arr[i].precio;
    }
    
    precioPromedio /= total;
    
    cout << "\nRESUMEN GENERAL DEL INVENTARIO:" << endl;
    cout << string(70, '-') << endl;
    cout << "Total de productos diferentes: " << total << endl;
    cout << "Total de unidades en stock: " << totalUnidades << endl;
    cout << "Valor total del inventario: $" << fixed << setprecision(2) 
         << valorTotalInventario << endl;
    cout << "Precio promedio por producto: $" << precioPromedio << endl;
    
    // Producto más caro
    int indiceMasCaro = 0;
    for(int i = 1; i < total; i++) {
        if(arr[i].precio > arr[indiceMasCaro].precio) {
            indiceMasCaro = i;
        }
    }
    
    cout << "\nProducto mas costoso: " << arr[indiceMasCaro].nombre 
         << " ($" << arr[indiceMasCaro].precio << ")" << endl;
    
    // Producto con más stock
    int indiceMayorStock = 0;
    for(int i = 1; i < total; i++) {
        if(arr[i].cantidad > arr[indiceMayorStock].cantidad) {
            indiceMayorStock = i;
        }
    }
    
    cout << "Mayor stock: " << arr[indiceMayorStock].nombre 
         << " (" << arr[indiceMayorStock].cantidad << " unidades)" << endl;
    
    cout << string(70, '=') << endl;
}

Producto* localizarProducto(Producto arr[], int total, int codigo) {
    for(int i = 0; i < total; i++) {
        if(arr[i].id == codigo) {
            return &arr[i];  // Retorna puntero al producto
        }
    }
    
    throw ExcepcionProductoNoEncontrado("Producto no encontrado con el codigo especificado.");
}

void intercambiar(Producto* a, Producto* b) {
    Producto temp = *a;
    *a = *b;
    *b = temp;
}

string obtenerFecha() {
    time_t ahora = time(0);
    tm* tiempoLocal = localtime(&ahora);
    
    char buffer[100];
    strftime(buffer, sizeof(buffer), "%d/%m/%Y %H:%M", tiempoLocal);
    return string(buffer);
}

void esperarUsuario() {
    cout << "\n[Presione ENTER para continuar]";
    cin.ignore();
    cin.get();
}
